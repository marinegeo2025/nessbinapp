name: Update Thursday Bin Schedule

on:
  schedule:
    - cron: "0 3 * * *"   # every day at 3 AM UTC (you can change to weekly)
  workflow_dispatch:       # allows manual trigger

jobs:
  update-thursday:
    runs-on: ubuntu-latest

    permissions:
      contents: write       # allow the workflow to push updates to your repo

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Puppeteer
        run: |
          npm install puppeteer@21

            - name: Scrape CNES Thursday Collections page
        run: |
          node - <<'EOF'
          import puppeteer from 'puppeteer';
          import fs from 'fs';

          const url = 'https://www.cne-siar.gov.uk/bins-and-recycling/waste-recycling-collections-lewis-and-harris/organic-food-and-garden-waste-and-mixed-recycling-blue-bin/thursday-collections';

          (async () => {
            try {
              const browser = await puppeteer.launch({
                headless: true,
                args: [
                  '--no-sandbox',
                  '--disable-setuid-sandbox',
                  '--disable-gpu',
                  '--disable-dev-shm-usage',
                  '--single-process'
                ]
              });

              const page = await browser.newPage();
              await page.goto(url, { waitUntil: 'networkidle2', timeout: 120000 });
              await page.waitForTimeout(10000); // allow JS accordions to render

              // üß© Extract only the relevant content
              const content = await page.evaluate(() => {
                const el = document.querySelector('.accordion-pane-group');
                return el ? el.outerHTML : '<p>‚ö†Ô∏è Could not find collection section.</p>';
              });

              // üßπ Wrap it in a minimal HTML doc for safety
              const cleanedHTML = `
              <!DOCTYPE html>
              <html lang="en">
              <head><meta charset="UTF-8"><title>Thursday Bin Data</title></head>
              <body>${content}</body>
              </html>`;

              fs.writeFileSync('thursday.html', cleanedHTML.trim(), 'utf8');
              await browser.close();
              console.log('‚úÖ Thursday schedule trimmed and saved successfully!');
            } catch (err) {
              console.error('‚ùå Scrape failed:', err);
              process.exit(1);
            }
          })();
          EOF

      - name: Commit updated files
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add thursday.html
          git commit -m "Auto-update Thursday bin data ($(date))" || echo "No changes to commit"
          git push
