name: Update Thursday Bin Schedule

on:
  schedule:
    - cron: "0 3 * * *"   # every day at 3 AM UTC
  workflow_dispatch:       # manual trigger option

jobs:
  update-thursday:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Puppeteer
        run: npm install puppeteer@21

      - name: Scrape CNES Thursday Collections page
        run: |
          node - <<'EOF'
          import puppeteer from 'puppeteer';
          import fs from 'fs';

          const url = 'https://www.cne-siar.gov.uk/bins-and-recycling/waste-recycling-collections-lewis-and-harris/organic-food-and-garden-waste-and-mixed-recycling-blue-bin/thursday-collections';

          (async () => {
            try {
              const browser = await puppeteer.launch({
                headless: true,
                args: [
                  '--no-sandbox',
                  '--disable-setuid-sandbox',
                  '--disable-gpu',
                  '--disable-dev-shm-usage',
                  '--single-process'
                ]
              });

              const page = await browser.newPage();
              await page.goto(url, { waitUntil: 'networkidle2', timeout: 120000 });
              await page.waitForTimeout(10000); // allow accordions to render

              // üß© Extract only the relevant accordion content
              const content = await page.evaluate(() => {
                const el = document.querySelector('.accordion-pane-group');
                return el ? el.outerHTML : '<p>‚ö†Ô∏è Could not find collection section.</p>';
              });

              // üïí Add a timestamp footer and wrap in minimal HTML
              const timestamp = new Date().toISOString();
              const cleanedHTML = `
              <!DOCTYPE html>
              <html lang="en">
              <head>
                <meta charset="UTF-8">
                <title>Thursday Bin Data</title>
                <meta name="last-updated" content="${timestamp}">
                <style>
                  body { font-family: Arial, sans-serif; padding: 10px; }
                  footer { margin-top: 20px; font-size: 0.9em; color: #666; }
                </style>
              </head>
              <body>
                ${content}
                <footer>Last updated automatically: ${timestamp}</footer>
              </body>
              </html>`;

              fs.writeFileSync('thursday.html', cleanedHTML.trim(), 'utf8');
              await browser.close();
              console.log('‚úÖ Thursday schedule scraped, cleaned, and timestamped!');
            } catch (err) {
              console.error('‚ùå Scrape failed:', err);
              process.exit(1);
            }
          })();
          EOF

      - name: Commit updated files
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add thursday.html
          git commit -m "Auto-update Thursday bin data ($(date))" || echo "No changes"
          git push
