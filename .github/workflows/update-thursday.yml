name: Update Thursday Bin Schedule

on:
  schedule:
    - cron: "0 3 * * *"   # runs daily at 3 AM UTC
  workflow_dispatch:       # allows manual trigger

jobs:
  update-thursday:
    runs-on: ubuntu-latest

    permissions:
      contents: write       # allow the workflow to push updates to your repo

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Puppeteer
        run: npm install puppeteer@21

      - name: Scrape CNES Thursday Collections page
        run: |
          node - <<'EOF'
          import puppeteer from 'puppeteer';
          import fs from 'fs';

          const url = 'https://www.cne-siar.gov.uk/bins-and-recycling/waste-recycling-collections-lewis-and-harris/organic-food-and-garden-waste-and-mixed-recycling-blue-bin/thursday-collections';
          const timestamp = new Date().toISOString();

          (async () => {
            try {
              const browser = await puppeteer.launch({
                headless: true,
                args: [
                  '--no-sandbox',
                  '--disable-setuid-sandbox',
                  '--disable-gpu',
                  '--disable-dev-shm-usage',
                  '--single-process'
                ]
              });

              const page = await browser.newPage();
              await page.goto(url, { waitUntil: 'networkidle2', timeout: 120000 });

              // click all accordion panes
              await page.evaluate(() => {
                document.querySelectorAll('.accordion-pane__title').forEach(btn => btn.click());
              });

              await page.waitForTimeout(3000); // allow expansion animations

              const html = await page.evaluate(() => {
                const container = document.querySelector('.accordion, .accordion-pane, .accordion-pane__content');
                return container ? container.outerHTML : '<p>⚠️ Could not find collection section.</p>';
              });

              const result = `
              <!DOCTYPE html>
              <html lang="en">
              <head>
                <meta charset="UTF-8">
                <title>Thursday Bin Data</title>
                <meta name="last-updated" content="${timestamp}">
                <style>
                  body { font-family: Arial, sans-serif; padding: 10px; }
                  footer { margin-top: 20px; font-size: 0.9em; color: #666; }
                </style>
              </head>
              <body>
                ${html}
                <footer>Last updated automatically: ${timestamp}</footer>
              </body>
              </html>`;

              fs.writeFileSync('thursday.html', result, 'utf8');
              await browser.close();
              console.log('✅ Thursday schedule scraped successfully!');
            } catch (err) {
              console.error('❌ Scrape failed:', err);
              process.exit(1);
            }
          })();
          EOF

      - name: Commit updated file
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add thursday.html
          git commit -m "Auto-update Thursday bin data ($(date))" || echo "No changes to commit"
          git push
