- name: Scrape CNES Friday Green Bin Collections (JSON)
  run: |
    node - <<'EOF'
    const puppeteer = require("puppeteer");
    const fs = require("fs");

    const URL =
      "https://www.cne-siar.gov.uk/bins-and-recycling/waste-recycling-collections-lewis-and-harris/glass-green-bin-collections/friday-collections";

    const OUTPUT = "green.json";
    const TMP = "green.tmp.json";
    const BACKUP = "green.last-good.json";

    const timestamp = new Date().toISOString();

    (async () => {
      try {
        const browser = await puppeteer.launch({
          headless: true,
          args: ["--no-sandbox", "--disable-setuid-sandbox"]
        });

        const page = await browser.newPage();
        await page.goto(URL, {
          waitUntil: "networkidle2",
          timeout: 120000
        });

        /* üç™ Accept cookies (best-effort) */
        await page.waitForTimeout(1000);
        await page.evaluate(() => {
          const btn = [...document.querySelectorAll("button")]
            .find(b => /accept/i.test(b.textContent));
          if (btn) btn.click();
        });

        /* ‚è≥ Wait for accordion panes */
        await page.waitForSelector(".accordion-pane", { timeout: 30000 });

        /* üîì Expand all panes */
        await page.evaluate(() => {
          document
            .querySelectorAll('button[aria-expanded="false"]')
            .forEach(b => b.click());
        });

        await page.waitForTimeout(500);

        /* üì¶ Extract GREEN data (text-first, dates optional) */
        const data = await page.evaluate(() => {
          const items = [];

          document.querySelectorAll(".accordion-pane").forEach(pane => {
            const area =
              pane.querySelector(".accordion-pane__heading")
                ?.textContent?.trim() || "";

            if (!area) return;

            const description =
              pane.querySelector("p")?.textContent?.trim() || "";

            const dates = Array.from(pane.querySelectorAll("ol li"))
              .map(li => li.textContent.trim())
              .filter(Boolean);

            // Require *some* meaningful content
            if (!dates.length && !description) return;

            items.push({
              area,
              description,
              dates
            });
          });

          return items;
        });

        if (!data.length) {
          throw new Error("No Green bin accordion data extracted");
        }

        const result = {
          lastUpdated: timestamp,
          count: data.length,
          results: data
        };

        /* üõ°Ô∏è FAILSAFE: Ness must exist (dates optional) */
        fs.writeFileSync(TMP, JSON.stringify(result, null, 2), "utf8");

        const hasNess = result.results.some(
          r =>
            /ness/i.test(r.area) &&
            (r.description || (Array.isArray(r.dates) && r.dates.length))
        );

        if (!hasNess) {
          throw new Error("Failsafe triggered: Ness entry missing");
        }

        if (fs.existsSync(OUTPUT)) {
          fs.copyFileSync(OUTPUT, BACKUP);
        }

        fs.renameSync(TMP, OUTPUT);

        await browser.close();
        console.log("‚úÖ Green bin data updated safely (failsafe passed)");
      } catch (err) {
        console.error("‚ùå Green scrape failed:", err.message);

        if (fs.existsSync(TMP)) {
          fs.unlinkSync(TMP);
        }

        process.exit(1);
      }
    })();
    EOF
